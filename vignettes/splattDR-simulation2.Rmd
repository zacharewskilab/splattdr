---
title: "R Notebook"
output: html_notebook
---

## Setting up the environment and displaying session information for reproducibility
```{r}
library(doParallel, quietly = TRUE)
library(dplyr, quietly = TRUE)
library(tidyr, quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(Seurat, quietly = TRUE)
library(scater, quietly = TRUE)
library(SingleCellExperiment, quietly = TRUE)
library(splatter, quietly = TRUE)
source_path = 'C:\\Users\\15177\\OneDrive - Michigan State University\\Documents\\Projects\\Prj161-snSeq-Mm_TCDD_DR_Sept2019\\snSeq-DGE\\R\\simulation_functions.R'
source('../R/dose_response_models.R')
source(source_path)
source('~/CodeSnippets/splatter/R/splat-simulate.R')
source('~/Projects/Prj161-snSeq-Mm_TCDD_DR_Sept2019/snSeq-DGE/R/splatterWrapper.R')
source('~/Projects/Prj161-snSeq-Mm_TCDD_DR_Sept2019/snSeq-DGE/R/simulation_functions_splatter.R')
sessionInfo()
memory.limit(size = 64000)
```

# Estimate Splat parameters from each dose group of the hepatocyte cluster
```{r eval = FALSE}
dr.dataset = readRDS('C:\\Users\\15177\\Downloads\\HPC-TempDownload\\FULL-TEMPORARY\\temporary3.liver.integrated.RData')
data.mat = dr.dataset@assays$RNA@data
rm(dr.dataset)
meta.data = readRDS('justmeta.RData')

params.list = readRDS('params.list.RData')
```

## Indepedent processing.
```{r fig.width = 12, fig.height = 18}
splat.param = data.frame(matrix(NA, ncol = 32, nrow = 0))
colnames(splat.param) = names(attributes(params.list[[1]]))
for (name in names(params.list)){
  splat.param[name,] = attributes(params.list[[name]])
}
splat.param$cell.dose = rownames(splat.param)
splat.param = splat.param %>% separate(cell.dose, c("cell","dose"), sep = '_')
```

```{r}
M = cor(splat.param[,c('batchCells', 'nCells','mean.rate', 'mean.shape', 'out.prob', 'out.facLoc', 'out.facScale', 'bcv.common', 'dropout.mid', 'dropout.shape', 'lib.loc', 'lib.scale')])
corrplot(M, order = "hclust")
```


```{r fig.width = 12, fig.height = 18}
splat.long = reshape2::melt(splat.param[,c('cell', 'dose','mean.rate', 'mean.shape', 'out.prob', 'out.facLoc', 'out.facScale', 'bcv.common', 'bcv.df', 'dropout.mid', 'dropout.shape', 'lib.loc', 'lib.scale')], id.var = c('cell','dose'))

ggplot(data = splat.long, aes(x = cell, y = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_boxplot() + 
  geom_jitter(aes(color = dose), size = 1.4, alpha = 0.5) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```


```{r}
param.medians = splat.long %>% group_by(cell, variable) %>% summarize(median = median(value)) %>% filter(cell == 'Macrophage') %>% spread(variable, median)
```


# Begin simulation of dose-response data
## Choose and set base splatter parameters object to initiate simulation
```{r}
params = newSplatParams()

params@mean.rate = param.medians$mean.rate
params@mean.shape = param.medians$mean.shape
params@lib.loc = param.medians$lib.loc
params@lib.scale = param.medians$lib.scale
params@out.prob = param.medians$out.prob
params@out.facLoc = param.medians$out.facLoc
params@out.facScale = param.medians$out.facScale
params@bcv.common = param.medians$bcv.common
params@bcv.df = param.medians$bcv.df
params@dropout.mid = param.medians$dropout.mid
params@dropout.shape = param.medians$dropout.shape
params@de.prob = 0.1
params@de.facLoc = 3
params@de.facScale = 0.8
dose.names = c(0, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30)
params@nBatches = 1
params@nCells = 500 * length(dose.names)
params@nGenes = 20000
dose.prob = rep(1/9, length(dose.names))
```

```{r}
simDR = splatSimulateDR(params, method = 'doseresp', dose.names = dose.names, dose.prob = dose.prob)
macrophage.sim = simDR
```

Compile summary statistics for comparison
```{r}
gene.summary = data.frame(Dataset = character(), Dose = factor(), mean = double(), var = double(), p.zero = double())
for (d in dose.names){
  sub.exp.mat = assays(simDR)$logcount[,which(colData(simDR)$Dose == d)]
  mean.vec = apply(sub.exp.mat, 1, function(x) mean(x))
  var.vec = apply(sub.exp.mat, 1, function(x) var(x))
  p.zero.vec = apply(sub.exp.mat, 1, function(x) length(x[which(x == 0)])/length(x))
  temp.df = data.frame(Dataset = 'SplattDR', Dose = d, mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
  gene.summary = rbind(gene.summary, temp.df)
}

for (d in dose.names){
  sub.exp.mat = as.matrix(data.mat[,which(meta.data$Dose == d & meta.data$new.cell.type == 'Macrophage')])
  mean.vec = apply(sub.exp.mat, 1, function(x) mean(x))
  var.vec = apply(sub.exp.mat, 1, function(x) var(x))
  p.zero.vec = apply(sub.exp.mat, 1, function(x) length(x[which(x == 0)])/length(x))
  temp.df = data.frame(Dataset = 'Real', Dose = d, mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
  gene.summary = rbind(gene.summary, temp.df)
}

cell.summary = data.frame(Dataset = character(), mean = double(), var = double(), p.zero = double())
sub.exp.mat = assays(simDR)$logcount
mean.vec = apply(sub.exp.mat, 2, function(x) mean(x))
var.vec = apply(sub.exp.mat, 2, function(x) var(x))
p.zero.vec = apply(sub.exp.mat, 2, function(x) length(x[which(x == 0)])/length(x))
temp.df = data.frame(Dataset = 'SplattDR', mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
cell.summary = rbind(cell.summary, temp.df)

sub.exp.mat = as.matrix(data.mat[,which(meta.data$new.cell.type == 'Macrophage')])
mean.vec = apply(sub.exp.mat, 2, function(x) mean(x))
var.vec = apply(sub.exp.mat, 2, function(x) var(x))
p.zero.vec = apply(sub.exp.mat, 2, function(x) length(x[which(x == 0)])/length(x))
temp.df = data.frame(Dataset = 'Real', mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
cell.summary = rbind(cell.summary, temp.df)
```

```{r fig.width = 14, fig.height = 9}
F1.A = ggplot(data = gene.summary, aes(x = factor(Dose), y = mean, color = Dataset)) + 
  geom_boxplot() +
  theme_bw()

F1.B = ggplot(data = gene.summary, aes(x = factor(Dose), y = var, color = Dataset)) + 
  geom_boxplot() +
  theme_bw()

F1.C = ggplot(data = gene.summary, aes(x = factor(Dose), y = p.zero, color = Dataset)) +
  geom_boxplot() +
  #geom_smooth() +
  theme_bw()

F1.D = ggplot(data = gene.summary, aes(x = mean, y = var, color = Dataset)) +
  geom_point(size = 0.7, alpha = 0.3) +
  #geom_smooth() +
  theme_bw()

F1.E = ggplot(data = cell.summary, aes(x = Dataset, y = p.zero)) +
  geom_boxplot() +
  #geom_smooth() +
  theme_bw()

figure = ggpubr::ggarrange(F1.A, F1.B, F1.C, F1.D, F1.E, labels = c("A","B","C", "D", "E"), ncol = 3, nrow = 2)
figure
```
```{r}
simDR = runPCA(simDR)
plotPCA(simDR, colour_by = "Dose")
```


#CT2

```{r}
param.medians = splat.long %>% group_by(cell, variable) %>% summarize(median = median(value)) %>% filter(cell == 'Hepatocytes - portal') %>% spread(variable, median)
```


# Begin simulation of dose-response data
## Choose and set base splatter parameters object to initiate simulation
```{r}
params = newSplatParams()

params@mean.rate = param.medians$mean.rate
params@mean.shape = param.medians$mean.shape
params@lib.loc = param.medians$lib.loc
params@lib.scale = param.medians$lib.scale
params@out.prob = param.medians$out.prob
params@out.facLoc = param.medians$out.facLoc
params@out.facScale = param.medians$out.facScale
params@bcv.common = param.medians$bcv.common
params@bcv.df = param.medians$bcv.df
params@dropout.mid = param.medians$dropout.mid
params@dropout.shape = param.medians$dropout.shape
params@de.prob = 0.1
params@de.facLoc = 3
params@de.facScale = 0.8
dose.names = c(0, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30)
params@nBatches = 1
params@nCells = 500 * length(dose.names)
params@nGenes = 20000
dose.prob = rep(1/9, length(dose.names))
```

```{r}
simDR = splatSimulateDR(params, method = 'doseresp', dose.names = dose.names, dose.prob = dose.prob)
hepatocyte.sim = simDR
```

Compile summary statistics for comparison
```{r}
gene.summary = data.frame(Dataset = character(), Dose = factor(), mean = double(), var = double(), p.zero = double())
for (d in dose.names){
  sub.exp.mat = assays(simDR)$logcount[,which(colData(simDR)$Dose == d)]
  mean.vec = apply(sub.exp.mat, 1, function(x) mean(x))
  var.vec = apply(sub.exp.mat, 1, function(x) var(x))
  p.zero.vec = apply(sub.exp.mat, 1, function(x) length(x[which(x == 0)])/length(x))
  temp.df = data.frame(Dataset = 'SplattDR', Dose = d, mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
  gene.summary = rbind(gene.summary, temp.df)
}

for (d in dose.names){
  sub.exp.mat = as.matrix(data.mat[,which(meta.data$Dose == d & meta.data$new.cell.type == 'Hepatocytes - portal')])
  mean.vec = apply(sub.exp.mat, 1, function(x) mean(x))
  var.vec = apply(sub.exp.mat, 1, function(x) var(x))
  p.zero.vec = apply(sub.exp.mat, 1, function(x) length(x[which(x == 0)])/length(x))
  temp.df = data.frame(Dataset = 'Real', Dose = d, mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
  gene.summary = rbind(gene.summary, temp.df)
}

cell.summary = data.frame(Dataset = character(), mean = double(), var = double(), p.zero = double())
sub.exp.mat = assays(simDR)$logcount
mean.vec = apply(sub.exp.mat, 2, function(x) mean(x))
var.vec = apply(sub.exp.mat, 2, function(x) var(x))
p.zero.vec = apply(sub.exp.mat, 2, function(x) length(x[which(x == 0)])/length(x))
temp.df = data.frame(Dataset = 'SplattDR', mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
cell.summary = rbind(cell.summary, temp.df)

sub.exp.mat = as.matrix(data.mat[,which(meta.data$new.cell.type == 'Hepatocytes - portal')])
mean.vec = apply(sub.exp.mat, 2, function(x) mean(x))
var.vec = apply(sub.exp.mat, 2, function(x) var(x))
p.zero.vec = apply(sub.exp.mat, 2, function(x) length(x[which(x == 0)])/length(x))
temp.df = data.frame(Dataset = 'Real', mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
cell.summary = rbind(cell.summary, temp.df)
```

```{r fig.width = 14, fig.height = 9}
F1.A = ggplot(data = gene.summary, aes(x = factor(Dose), y = mean, color = Dataset)) + 
  geom_boxplot() +
  theme_bw()

F1.B = ggplot(data = gene.summary, aes(x = factor(Dose), y = var, color = Dataset)) + 
  geom_boxplot() +
  theme_bw()

F1.C = ggplot(data = gene.summary, aes(x = factor(Dose), y = p.zero, color = Dataset)) +
  geom_boxplot() +
  #geom_smooth() +
  theme_bw()

F1.D = ggplot(data = gene.summary, aes(x = mean, y = var, color = Dataset)) +
  geom_point(size = 0.7, alpha = 0.3) +
  #geom_smooth() +
  theme_bw()

F1.E = ggplot(data = cell.summary, aes(x = Dataset, y = p.zero)) +
  geom_boxplot() +
  #geom_smooth() +
  theme_bw()

figure = ggpubr::ggarrange(F1.A, F1.B, F1.C, F1.D, F1.E, labels = c("A","B","C", "D", "E"), ncol = 3, nrow = 2)
figure
```

```{r}
simDR = runPCA(simDR)
plotPCA(simDR, colour_by = "Dose")
```


#CT3

```{r}
param.medians = splat.long %>% group_by(cell, variable) %>% summarize(median = median(value)) %>% filter(cell == 'Neutrophils') %>% spread(variable, median)
```


# Begin simulation of dose-response data
## Choose and set base splatter parameters object to initiate simulation
```{r}
params = newSplatParams()

params@mean.rate = param.medians$mean.rate
params@mean.shape = param.medians$mean.shape
params@lib.loc = param.medians$lib.loc
params@lib.scale = param.medians$lib.scale
params@out.prob = param.medians$out.prob
params@out.facLoc = param.medians$out.facLoc
params@out.facScale = param.medians$out.facScale
params@bcv.common = param.medians$bcv.common
params@bcv.df = param.medians$bcv.df
params@dropout.mid = param.medians$dropout.mid
params@dropout.shape = param.medians$dropout.shape
params@de.prob = 0.1
params@de.facLoc = 3
params@de.facScale = 0.8
dose.names = c(0, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30)
params@nBatches = 1
params@nCells = 500 * length(dose.names)
params@nGenes = 20000
dose.prob = rep(1/9, length(dose.names))
```

```{r}
simDR = splatSimulateDR(params, method = 'doseresp', dose.names = dose.names, dose.prob = dose.prob)
neutrophil.sim = simDR
```

Compile summary statistics for comparison
```{r}
gene.summary = data.frame(Dataset = character(), Dose = factor(), mean = double(), var = double(), p.zero = double())
for (d in dose.names){
  sub.exp.mat = assays(simDR)$logcount[,which(colData(simDR)$Dose == d)]
  mean.vec = apply(sub.exp.mat, 1, function(x) mean(x))
  var.vec = apply(sub.exp.mat, 1, function(x) var(x))
  p.zero.vec = apply(sub.exp.mat, 1, function(x) length(x[which(x == 0)])/length(x))
  temp.df = data.frame(Dataset = 'SplattDR', Dose = d, mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
  gene.summary = rbind(gene.summary, temp.df)
}

for (d in dose.names){
  sub.exp.mat = as.matrix(data.mat[,which(meta.data$Dose == d & meta.data$new.cell.type == 'Neutrophils')])
  mean.vec = apply(sub.exp.mat, 1, function(x) mean(x))
  var.vec = apply(sub.exp.mat, 1, function(x) var(x))
  p.zero.vec = apply(sub.exp.mat, 1, function(x) length(x[which(x == 0)])/length(x))
  temp.df = data.frame(Dataset = 'Real', Dose = d, mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
  gene.summary = rbind(gene.summary, temp.df)
}

cell.summary = data.frame(Dataset = character(), mean = double(), var = double(), p.zero = double())
sub.exp.mat = assays(simDR)$logcount
mean.vec = apply(sub.exp.mat, 2, function(x) mean(x))
var.vec = apply(sub.exp.mat, 2, function(x) var(x))
p.zero.vec = apply(sub.exp.mat, 2, function(x) length(x[which(x == 0)])/length(x))
temp.df = data.frame(Dataset = 'SplattDR', mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
cell.summary = rbind(cell.summary, temp.df)

sub.exp.mat = as.matrix(data.mat[,which(meta.data$new.cell.type == 'Neutrophils')])
mean.vec = apply(sub.exp.mat, 2, function(x) mean(x))
var.vec = apply(sub.exp.mat, 2, function(x) var(x))
p.zero.vec = apply(sub.exp.mat, 2, function(x) length(x[which(x == 0)])/length(x))
temp.df = data.frame(Dataset = 'Real', mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
cell.summary = rbind(cell.summary, temp.df)
```

```{r fig.width = 14, fig.height = 9}
F1.A = ggplot(data = gene.summary, aes(x = factor(Dose), y = mean, color = Dataset)) + 
  geom_boxplot() +
  theme_bw()

F1.B = ggplot(data = gene.summary, aes(x = factor(Dose), y = var, color = Dataset)) + 
  geom_boxplot() +
  theme_bw()

F1.C = ggplot(data = gene.summary, aes(x = factor(Dose), y = p.zero, color = Dataset)) +
  geom_boxplot() +
  #geom_smooth() +
  theme_bw()

F1.D = ggplot(data = gene.summary, aes(x = mean, y = var, color = Dataset)) +
  geom_point(size = 0.7, alpha = 0.3) +
  #geom_smooth() +
  theme_bw()

F1.E = ggplot(data = cell.summary, aes(x = Dataset, y = p.zero)) +
  geom_boxplot() +
  #geom_smooth() +
  theme_bw()

figure = ggpubr::ggarrange(F1.A, F1.B, F1.C, F1.D, F1.E, labels = c("A","B","C", "D", "E"), ncol = 3, nrow = 2)
figure
```

```{r}
simDR = runPCA(simDR)
plotPCA(simDR, colour_by = "Dose")
```





#CT4

```{r}
param.medians = splat.long %>% group_by(cell, variable) %>% summarize(median = median(value)) %>% filter(cell == 'Macrophage') %>% spread(variable, median)
```


# Begin simulation of dose-response data
## Choose and set base splatter parameters object to initiate simulation
```{r}
params = newSplatParams()

params@mean.rate = param.medians$mean.rate
params@mean.shape = param.medians$mean.shape
params@lib.loc = param.medians$lib.loc
params@lib.scale = param.medians$lib.scale
params@out.prob = param.medians$out.prob
params@out.facLoc = param.medians$out.facLoc
params@out.facScale = param.medians$out.facScale
params@bcv.common = param.medians$bcv.common
params@bcv.df = param.medians$bcv.df
params@dropout.mid = param.medians$dropout.mid
params@dropout.shape = param.medians$dropout.shape
params@de.prob = 0.1
params@de.facLoc = 3
params@de.facScale = 0.8
dose.names = c(0, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30)
params@nBatches = 1
params@nCells = 500 * length(dose.names)
params@nGenes = 20000
dose.prob = rep(1/9, length(dose.names))
```

```{r}
simDR = splatSimulateDR(params, method = 'doseresp', dose.names = dose.names, dose.prob = c(0.2, 0.2, 0.15, 0.1, 0.1, 0.08, 0.06, 0.06, 0.05))
macro.alt.sim = simDR
```

Compile summary statistics for comparison
```{r}
gene.summary = data.frame(Dataset = character(), Dose = factor(), mean = double(), var = double(), p.zero = double())
for (d in dose.names){
  sub.exp.mat = assays(simDR)$logcount[,which(colData(simDR)$Dose == d)]
  mean.vec = apply(sub.exp.mat, 1, function(x) mean(x))
  var.vec = apply(sub.exp.mat, 1, function(x) var(x))
  p.zero.vec = apply(sub.exp.mat, 1, function(x) length(x[which(x == 0)])/length(x))
  temp.df = data.frame(Dataset = 'SplattDR', Dose = d, mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
  gene.summary = rbind(gene.summary, temp.df)
}

for (d in dose.names){
  sub.exp.mat = as.matrix(data.mat[,which(meta.data$Dose == d & meta.data$new.cell.type == 'Macrophage')])
  mean.vec = apply(sub.exp.mat, 1, function(x) mean(x))
  var.vec = apply(sub.exp.mat, 1, function(x) var(x))
  p.zero.vec = apply(sub.exp.mat, 1, function(x) length(x[which(x == 0)])/length(x))
  temp.df = data.frame(Dataset = 'Real', Dose = d, mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
  gene.summary = rbind(gene.summary, temp.df)
}

cell.summary = data.frame(Dataset = character(), mean = double(), var = double(), p.zero = double())
sub.exp.mat = assays(simDR)$logcount
mean.vec = apply(sub.exp.mat, 2, function(x) mean(x))
var.vec = apply(sub.exp.mat, 2, function(x) var(x))
p.zero.vec = apply(sub.exp.mat, 2, function(x) length(x[which(x == 0)])/length(x))
temp.df = data.frame(Dataset = 'SplattDR', mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
cell.summary = rbind(cell.summary, temp.df)

sub.exp.mat = as.matrix(data.mat[,which(meta.data$new.cell.type == 'Macrophage')])
mean.vec = apply(sub.exp.mat, 2, function(x) mean(x))
var.vec = apply(sub.exp.mat, 2, function(x) var(x))
p.zero.vec = apply(sub.exp.mat, 2, function(x) length(x[which(x == 0)])/length(x))
temp.df = data.frame(Dataset = 'Real', mean = mean.vec, var = var.vec, p.zero = p.zero.vec)
cell.summary = rbind(cell.summary, temp.df)
```

```{r fig.width = 14, fig.height = 9}
F1.A = ggplot(data = gene.summary, aes(x = factor(Dose), y = mean, color = Dataset)) + 
  geom_boxplot() +
  theme_bw()

F1.B = ggplot(data = gene.summary, aes(x = factor(Dose), y = var, color = Dataset)) + 
  geom_boxplot() +
  theme_bw()

F1.C = ggplot(data = gene.summary, aes(x = factor(Dose), y = p.zero, color = Dataset)) +
  geom_boxplot() +
  #geom_smooth() +
  theme_bw()

F1.D = ggplot(data = gene.summary, aes(x = mean, y = var, color = Dataset)) +
  geom_point(size = 0.7, alpha = 0.3) +
  #geom_smooth() +
  theme_bw()

F1.E = ggplot(data = cell.summary, aes(x = Dataset, y = p.zero)) +
  geom_boxplot() +
  #geom_smooth() +
  theme_bw()

figure = ggpubr::ggarrange(F1.A, F1.B, F1.C, F1.D, F1.E, labels = c("A","B","C", "D", "E"), ncol = 3, nrow = 2)
figure
```

```{r}
simDR = runPCA(simDR)
plotPCA(simDR, colour_by = "Dose")
```