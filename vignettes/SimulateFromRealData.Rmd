---
title: "splattDR: Simulating from Real Data and Validating"
author: "Rance Nault"
package: "splattdr"
data: "Last updated: May 12, 2021"
output: 
  BiocStyle::html_document:
    toc: true
    toc_float: true
  vignette: >
    %\VignetteIndexEntry{simple DR simulation}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

# Introduction
In this vignette we demonstrate how `splatSimulateDR` is used to simulate dose-
response data based on parameters derived from real data using `splatEstimate`
from the `splatter` [package.](https://bioconductor.org/packages/release/bioc/html/splatter.html)
This vignette can take several hours to run depending on the size of the real
dataset and the number of cell types. 
```{r}
# Load packages
suppressPackageStartupMessages({
  library("Seurat")
  library("splattdr")
  library("splatter")
  library("ggplot2")
  library("ggpubr")
  library("dplyr")
  library("scater")
})

set.seed(518)
```

```{r}
# Model fitting equations for diagnostic plots
fo <- PctZero * 100 ~ a * exp(b * MeanLog) + t
fv <- VarLog ~ poly(MeanLog, 3)
```

# Importing an annotated single-cell/nuclei dataset saved as Seurat dataset
```{r eval = FALSE}
real.data = readRDS('/mnt/home/naultran/SNSEQDATA_FINAL/Zacharewski.tcdd.snseq.doseresponse.011321.RData') #Change to DR Dataset
colnames(real.data@meta.data)[107] = 'celltype'
unique.celltypes = unique(real.data$celltype)
DimPlot(real.data, label = TRUE, group.by = 'celltype') + NoLegend()
```

```{r eval = FALSE}
real.data = readRDS('/mnt/home/naultran/SNSEQDATA_FINAL/GSE148339_liver.integrated.final.RData')
unique.celltypes = unique(real.data$celltype)
DimPlot(real.data, label = TRUE, group.by = 'celltype') + NoLegend()
```


```{r eval = FALSE}
real.data = readRDS('xiong.nash.cellannotated.RData')
unique.celltypes = unique(real.data$celltype)
DimPlot(real.data, label = TRUE, group.by = 'celltype') + NoLegend()
```

```{r eval = FALSE}
library(SeuratData)
data("pbmc3k.final")
pbmc3k.final$celltype = pbmc3k.final$seurat_annotations
real.data = pbmc3k.final
unique.celltypes = unique(real.data$celltype)
DimPlot(real.data, label = TRUE, group.by = 'celltype') + NoLegend()
```

# Estimate simulation starting parameters from real data
`splatEstimate` is used to calculate parameters from a real dataset.
Alternatively, a set of default parameters can be obtained using `data(params)`
to begin simulating data without having a real dataset.

```{r}
sca <- as.SingleCellExperiment(
  subset(real.data, cells = sample(colnames(real.data), 10000, replace = FALSE))
         )
counts <- as.matrix(counts(sca))
params.full <- splatEstimate(counts)
saveRDS(params.full, file = 'params.full.062421.RData')
```


```{r}
sim.dose = c(0, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30)
dose.prob = rep(1/9, 9)
group.Size = 3
n.Cells = 500*9
n.Genes = 10000
```


```{r}
# Setup params object for dose-response simulation
params = params.full
params@nBatches = length(sim.dose)*3
params@batch.facLoc = rep(0.1, params@nBatches)
params@batch.facScale = rep(0.1, params@nBatches)
params@nCells = n.Cells
params@nGenes = n.Genes

num.cells = mean(table(real.data$celltype))
saveRDS(table(real.data$celltype), file = 'real.data.table.062421.RData')
```


```{r}
sim.full = splatSimulateDR(params, dose.names = sim.dose, 
                                   dose.prob = dose.prob, 
                                   lib.scale = 60*num.cells^-0.4, 
                                   verbose = FALSE)
```

```{r}
geneData = rbind(
  summarizeGene(sca,'Real', 'full'),
  summarizeGene(sim.full, 'Simulated', 'full')
)

cellData = rbind(
  summarizeCell(sca, 'Real', 'full'),
  summarizeCell(sim.full, 'Simulated', 'full')
)

geneReal <- geneData %>% filter(type  == 'Real')
geneSim <- geneData %>%filter(type == 'Simulated')

full.model <- nls(fo, geneReal, start = list(a = 100, b = -1, t = 1))
full.model.var <- lm(fv, geneReal)
geneReal$zero.predicted <- predict(full.model, newdata = geneReal[,c('MeanLog'), drop=FALSE])
geneReal$var.predicted <- predict(full.model.var, geneReal)

rmse.real <- RMSE(geneReal$PctZero*100, predict(full.model, newdata = geneReal[,c('MeanLog'), drop=FALSE]))
rmse.sim <- RMSE(geneSim$PctZero*100, predict(full.model, newdata = geneSim[,c('MeanLog'), drop=FALSE]))

var.rmse.real <- RMSE(geneReal$VarLog, predict(full.model.var, geneReal))
var.rmse.sim <- RMSE(geneSim$VarLog, predict(full.model.var, geneSim))
saveRDS(geneData, file = 'geneData.062421.RData')
saveRDS(cellData, file = 'cellData.062421.RData')
```


```{r fig.width = 8}
full.MeanZero = ggplot(data = geneData, aes(x = MeanLog, y = PctZero*100, fill = type)) +
  geom_point(shape = 21, size = 1.5, alpha = 0.8) + 
  scale_fill_manual(values = c('blue', 'red')) +
  labs(x = "Mean log expression", y = "Percent Zero") +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = c(0.85,0.8),
    legend.background = element_rect(fill = "transparent"),
    legend.text = element_text(size = rel(1.05))
  )
full.MeanZero
```


```{r fig.width = 8}
full.MeanVar = ggplot(data = geneData, aes(x = MeanLog, y = VarLog, fill = type)) +
  geom_point(shape = 21, size = 1.5, alpha = 0.8) +
  scale_fill_manual(values = c('blue', 'red')) +
  geom_line(data = geneReal, aes(x = MeanLog, y = var.predicted), color = 'black', size = 1.2) +
  labs(x = "Mean log expression", y = "Log expression variance") +
  annotate(geom="text", x = 2, y = 0, 
           label = paste0('NRMSD: ',round(var.rmse.sim['nrmsd'],2))) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = c(0.85,0.8),
    legend.background = element_rect(fill = "transparent"),
    legend.text = element_text(size = rel(1.05))
  )
full.MeanVar
```
```{r}
colData(sca)$Dose <- ifelse(colData(sca)$treatment == 'CONTROL', 0, 30)
real.fc <- calcFC(sca)
sim.fc <- calcFC(sim.full)

fc.df <- data.frame(
  dataset = c(rep('Real', nrow(real.fc)), rep('Simulated', nrow(sim.fc))),
  foldchange = c(real.fc$fc..dose.., sim.fc$calculatedFC30)
)

ggplot(data = fc.df, aes(x = foldchange, fill = dataset)) +
  #facet_wrap(~dataset) +
  geom_density(size = 0.6, alpha = 0.6, aes(y=..scaled..)) + 
  theme_bw()
```

# Evaluating simulations from cell-specific derived parameters
```{r}
n.Genes = 4000
params.list = list()
for (ct in unique.celltypes){
  print(ct)
  cell.subset = subset(real.data, subset = celltype == ct)
  if (length(colnames(cell.subset)) > 5000){
    print('shrinking')
    sampled.cells = sample(colnames(cell.subset), 5000, replace = FALSE)
    cell.subset = subset(cell.subset, cells = sampled.cells)  
  }
  
  sca = as.SingleCellExperiment(cell.subset)

  counts = as.matrix(counts(sca))
  params.list[[ct]] = splatEstimate(counts)
  rm(cell.subset) #clear RAM space
  rm(sca) #clear RAM space
  rm(counts) #clear RAM space
  saveRDS(params.list, file = 'params.list.RData')
}
```

# Update parameters for simulation of dose-responses
We want to update the `params` objects with simulation parameters. Here we use 
the same study design consisting of 9 doses and 3 biological replicates. We
simulate 4500 cells equally distributed among the doses and 5000 unique genes. 

```{r}
sim.list = list()

for (ct in unique.celltypes){
  params = params.list[[ct]]
  params@nBatches = length(sim.dose)*3
  params@batch.facLoc = rep(0.1, params@nBatches)
  params@batch.facScale = rep(0.1, params@nBatches)
  params@nCells = n.Cells
  params@nGenes = n.Genes
  num.cells = table(real.data$celltype)[ct]
  
  print(ct)
  sim.list[[ct]] = splatSimulateDR(params, dose.names = sim.dose, 
                                   dose.prob = dose.prob, 
                                   lib.scale = 60*num.cells^-0.4, 
                                   verbose = FALSE)
  saveRDS(sim.list, file = 'sim.list.RData')
}
```

```{r}
gene.summaries.list = list()
cell.summaries.list = list()
stat.values = list()
models = list()
for (ct in unique.celltypes){
  print(ct)
  cell.subset = subset(real.data, subset = celltype == ct)
  if (length(colnames(cell.subset)) > 5000){
    print('shrinking')
    sampled.cells = sample(colnames(cell.subset), 5000, replace = FALSE)
    cell.subset = subset(cell.subset, cells = sampled.cells)  
  }
  
  sca = as.SingleCellExperiment(cell.subset)
  counts = as.matrix(counts(sca))
  
  gene.summaries.list[[ct]] = rbind(
    summarizeGene(sca,'Real', ct),
    summarizeGene(sim.list[[ct]], 'Simulated', ct)
  )

  cell.summaries.list[[ct]] = rbind(
    summarizeCell(sca, 'Real', ct),
    summarizeCell(sim.list[[ct]], 'Simulated', ct)
  )
  
  # Split real and simulated data
  geneReal <- gene.summaries.list[[ct]] %>% filter(type  == 'Real')
  geneSim <- gene.summaries.list[[ct]] %>%filter(type == 'Simulated')
  
  # Fit models to real data
  model <- nls(fo, geneReal, start = list(a = 100, b = -1, t = 1))
  model.var <- lm(fv, geneReal)
  
  # Calculate RMSE values
  rmse.real <- RMSE(geneReal$PctZero*100, 
                    predict(model, newdata = geneReal[,c('MeanLog')]))
  rmse.sim <- RMSE(geneSim$PctZero*100, 
                   predict(model, newdata = geneSim[,c('MeanLog')]))
  
  var.rmse.real <- RMSE(geneReal$VarLog, predict(model.var, geneReal))
  var.rmse.sim <- RMSE(geneSim$VarLog, predict(model.var, geneSim))

  stat.values[[ct]] = c(real = rmse.real, 
                        sim = rmse.sim, 
                        var.real = var.rmse.real, 
                        var.sim = var.rmse.sim, 
                        ncells = length(colnames(cell.subset))
                        )
  models[[ct]] = c(mod.1 = model, mod.2 = model.var)
  
  print(ct)
  print(stat.values[[ct]])
  saveRDS(gene.summaries.list, file = 'gene.summaries2.list.062421.RData')
  saveRDS(cell.summaries.list, file = 'cell.summaries2.list.062421.RData')
  saveRDS(stat.values, file = 'stat.values.062421.RData')
  saveRDS(models, file = 'models.062421.RData')

}
geneData = do.call("rbind", gene.summaries.list)
cellData = do.call("rbind", cell.summaries.list)
statData = data.frame(do.call("rbind", stat.values))
```

```{r fig.width = 12, fig.height = 6}
MeanZero = ggplot(data = geneData, aes(x = MeanLog, y = PctZero*100, fill = type)) +
  facet_wrap(~name) +
  geom_point(shape = 21, size = 1.5, alpha = 0.8) + 
  scale_fill_manual(values = c('blue', 'red')) +
  labs(x = "Mean log expression", y = "Percent Zero") +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = c(0.85,0.85),
    legend.background = element_rect(fill = "transparent"),
    legend.text = element_text(size = rel(1))
  )
MeanZero
```


```{r fig.width = 12, fig.height = 6}
MeanVar = ggplot(data = geneData, aes(x = MeanLog, y = VarLog, fill = type)) +
  facet_wrap(~name) +
  geom_point(shape = 21, size = 1.5, alpha = 0.8) + 
  scale_fill_manual(values = c('blue', 'red')) +
  labs(x = "Mean log expression", y = "Log expression variance") +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.position = c(0.85,0.85),
    legend.background = element_rect(fill = "transparent"),
    legend.text = element_text(size = rel(1))
  )
MeanVar
```
